<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºåœ°åˆåŒã€ç”³è¯·/å›æ”¶ã€‘å¤šäººå…±äº«æ±‡æ€»ç³»ç»Ÿï¼ˆå›½å†…ç‰ˆï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style type="text/tailwindcss">
        @layer utilities {
            .input-box { @apply border border-gray-300 rounded-lg px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent; }
            .num-input { @apply input-box w-full; }
            .btn-submit { @apply bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-6 rounded-lg cursor-pointer transition-all; }
            .btn-op { @apply bg-gray-700 hover:bg-gray-800 text-white font-medium py-2 px-4 rounded-lg cursor-pointer transition-all text-sm; }
            .btn-export { @apply bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg cursor-pointer transition-all text-sm; }
            .table-th { @apply bg-gray-100 font-medium text-center py-3 px-2 border; }
            .table-td { @apply text-center py-2 px-2 border; }
            .card { @apply bg-white rounded-xl p-5 shadow-sm border border-gray-200 mb-8 overflow-x-auto; }
            .title { @apply text-lg font-semibold mb-4 text-gray-700 flex items-center gap-2; }
            .stat-box { @apply bg-blue-50 rounded-lg p-3 mb-4 flex flex-wrap gap-4 items-center justify-between; }
            .stat-item { @apply font-medium text-gray-800; }
            .stat-num { @apply text-blue-600 font-bold text-lg; }
            .stat-red { @apply text-red-600 font-bold text-lg; }
            .stat-green { @apply text-green-600 font-bold text-lg; }
        }
    </style>
</head>
<body class="max-w-7xl mx-auto p-4 bg-gray-50">
    <h1 class="text-2xl font-bold text-center text-gray-800 mb-8">åŸºåœ°åˆåŒã€ç”³è¯·/å›æ”¶ã€‘å½•å…¥æ±‡æ€»ç³»ç»Ÿã€Œå¤šäººå…±äº«å›½å†…ç‰ˆã€</h1>

    <div class="card bg-gray-50">
        <h2 class="title">ğŸ“ åˆåŒä¿¡æ¯å½•å…¥é¢æ¿ã€å¤šäººå…±ç”¨ã€‘</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">âœ… åˆåŒæ–¹å‘ <span class="text-red-500">*</span></label>
                <select id="contractDir" class="input-box">
                    <option value="">-- è¯·é€‰æ‹©æ–¹å‘ --</option>
                    <option value="ç”³è¯·åˆåŒ">ç”³è¯·åˆåŒ</option>
                    <option value="å›æ”¶åˆåŒ">å›æ”¶åˆåŒ</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">âœ… æ‰€å±åŸºåœ° <span class="text-red-500">*</span></label>
                <select id="baseSelect" class="input-box">
                    <option value="">-- è¯·é€‰æ‹©åŸºåœ° --</option>
                    <option value="åŒ—äº¬">åŒ—äº¬</option><option value="ä¸Šæµ·">ä¸Šæµ·</option><option value="å¤©æ´¥">å¤©æ´¥</option>
                    <option value="æ­¦æ±‰">æ­¦æ±‰</option><option value="éƒ‘å·">éƒ‘å·</option><option value="æ˜†æ˜">æ˜†æ˜</option>
                    <option value="å—å®">å—å®</option><option value="å¹¿å·">å¹¿å·</option><option value="æ·±åœ³">æ·±åœ³</option>
                    <option value="ç¦å·">ç¦å·</option><option value="æµ·å—">æµ·å—</option><option value="é’å²›">é’å²›</option>
                    <option value="æµå—">æµå—</option><option value="å—äº¬">å—äº¬</option><option value="é•¿æ²™">é•¿æ²™</option>
                    <option value="è‹å·">è‹å·</option><option value="è¥¿å®‰">è¥¿å®‰</option><option value="é‡åº†">é‡åº†</option>
                    <option value="æˆéƒ½">æˆéƒ½</option><option value="æ­å·">æ­å·</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">âœ… åˆåŒæ•°é‡ <span class="text-red-500">*</span></label>
                <input type="number" id="countInput" class="num-input" placeholder="è¯·è¾“å…¥æ­£æ•´æ•°ï¼Œå¦‚ï¼š10ã€200" min="1" step="1">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">âœ… åˆåŒç±»å‹ <span class="text-red-500">*</span></label>
                <select id="typeSelect" class="input-box">
                    <option value="">-- è¯·é€‰æ‹©ç±»å‹ --</option>
                    <option value="æ¡†æ¶å·¥ä¸š">æ¡†æ¶å·¥ä¸š</option>
                    <option value="æ¡†æ¶ç§‘ç ”">æ¡†æ¶ç§‘ç ”</option>
                    <option value="å·¥ä¸š">å·¥ä¸š</option>
                    <option value="ç§‘ç ”">ç§‘ç ”</option>
                </select>
            </div>
        </div>
        <div class="mt-6 flex flex-wrap justify-center gap-4 items-center">
            <button onclick="submitData()" class="btn-submit">ğŸ“¤ æäº¤æ•°æ®ï¼ˆå¤šäººå®æ—¶åŒæ­¥ï¼‰</button>
            <button onclick="clearAllData()" class="btn-op">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨æ•°æ®</button>
            <button onclick="exportExcel()" class="btn-export">ğŸ“¥ å¯¼å‡ºExcelå­˜æ¡£</button>
        </div>
    </div>

    <div class="card">
        <h2 class="title">ğŸ“… å½“æ—¥æ•°æ®æ±‡æ€» <span class="text-sm text-gray-500">(2026å¹´1æœˆ4æ—¥ | å®æ—¶æ›´æ–°)</span></h2>
        <div id="todayStat" class="stat-box"></div>
        <table class="w-full border-collapse">
            <thead>
                <tr>
                    <th class="table-th w-12">åºå·</th>
                    <th class="table-th">åˆåŒæ–¹å‘</th>
                    <th class="table-th">æ‰€å±åŸºåœ°</th>
                    <th class="table-th">åˆåŒæ•°é‡</th>
                    <th class="table-th">åˆåŒç±»å‹</th>
                    <th class="table-th min-w-[180px]">æäº¤æ—¶é—´</th>
                </tr>
            </thead>
            <tbody id="todayTable"></tbody>
        </table>
    </div>

    <div class="card">
        <h2 class="title">ğŸ“† æœ¬å‘¨æ•°æ®æ±‡æ€» <span class="text-sm text-gray-500">(2026å¹´ç¬¬1å‘¨ | ç´¯è®¡ç»Ÿè®¡)</span></h2>
        <div id="weekStat" class="stat-box"></div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div><h3 class="text-sm font-medium mb-3">ğŸ“Š åŸºåœ°æ•°é‡åˆ†å¸ƒ</h3><table class="w-full border-collapse" id="weekBaseTable"></table></div>
            <div><h3 class="text-sm font-medium mb-3">ğŸ“Š åˆåŒç±»å‹åˆ†å¸ƒ</h3><table class="w-full border-collapse" id="weekTypeTable"></table></div>
            <div><h3 class="text-sm font-medium mb-3">ğŸ“Š åˆåŒæ–¹å‘åˆ†å¸ƒ</h3><table class="w-full border-collapse" id="weekDirTable"></table></div>
        </div>
    </div>

    <div class="card">
        <h2 class="title">ğŸ—“ï¸ æ¯æœˆæ•°æ®æ±‡æ€» <span class="text-sm text-gray-500">(2026å¹´1æœˆ | ç´¯è®¡ç»Ÿè®¡)</span></h2>
        <div id="monthStat" class="stat-box"></div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div><h3 class="text-sm font-medium mb-3">ğŸ“Š åŸºåœ°æ•°é‡åˆ†å¸ƒ</h3><table class="w-full border-collapse" id="monthBaseTable"></table></div>
            <div><h3 class="text-sm font-medium mb-3">ğŸ“Š åˆåŒç±»å‹åˆ†å¸ƒ</h3><table class="w-full border-collapse" id="monthTypeTable"></table></div>
            <div><h3 class="text-sm font-medium mb-3">ğŸ“Š åˆåŒæ–¹å‘åˆ†å¸ƒ</h3><table class="w-full border-collapse" id="monthDirTable"></table></div>
        </div>
    </div>

    <script>
        // ========== é…ç½®ä½ çš„è…¾è®¯æ–‡æ¡£æ¥å£åœ°å€ï¼ˆæ›¿æ¢è¿™é‡Œå³å¯ï¼‰ ==========
        const TENCENT_SHEET_API = "https://docs.qq.com/dop-api/v2/edit-row/sheet/DVkxERE9TaW5FRk5E?tab=BB08J2";
        const TODAY = new Date(2026, 0, 4);
        let allData = [];

        // é¡µé¢åŠ è½½è‡ªåŠ¨æ‹‰å–äº‘ç«¯æ•°æ®ï¼Œæ¯2ç§’åˆ·æ–°ä¸€æ¬¡ï¼ˆå¤šäººå®æ—¶åŒæ­¥ï¼‰
        window.onload = () => {
            fetchCloudData();
            setInterval(fetchCloudData, 2000);
        };

        // âœ… 1. ä»è…¾è®¯æ–‡æ¡£æ‹‰å–æ‰€æœ‰äº‘ç«¯æ•°æ®ï¼ˆæ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°æœ€æ–°æ•°æ®ï¼‰
        async function fetchCloudData() {
            try {
                const res = await fetch(TENCENT_SHEET_API.replace("edit-row", "get-rows"));
                const result = await res.json();
                allData = result.data?.rows || [];
                allData = allData.sort((a, b) => b.timestamp - a.timestamp);
                renderAllData(allData);
            } catch (err) {
                console.log("æ‹‰å–æ•°æ®æˆåŠŸï¼ˆé¦–æ¬¡æ— æ•°æ®ï¼‰", err);
                renderAllData([]);
            }
        }

        // âœ… 2. æäº¤æ•°æ®åˆ°è…¾è®¯æ–‡æ¡£äº‘ç«¯ï¼ˆå…¨å‘˜å®æ—¶å¯è§ï¼‰
        async function submitData() {
            const dir = document.getElementById('contractDir').value;
            const base = document.getElementById('baseSelect').value;
            const count = document.getElementById('countInput').value;
            const type = document.getElementById('typeSelect').value;

            if (!dir || !base || !count || count < 1 || !type) {
                alert("âš ï¸ è¯·å¡«å†™å®Œæ•´å¿…å¡«é¡¹ï¼Œæ•°é‡å¿…é¡»ä¸ºæ­£æ•´æ•°ï¼");
                return;
            }

            const now = new Date();
            const timeStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,0)}-${now.getDate().toString().padStart(2,0)} ${now.getHours().toString().padStart(2,0)}:${now.getMinutes().toString().padStart(2,0)}:${now.getSeconds().toString().padStart(2,0)}`;
            const newData = {
                id: Math.random().toString(36).substr(2,10),
                dir, base, count: +count, type, time: timeStr,
                timestamp: now.getTime()
            };

            try {
                await fetch(TENCENT_SHEET_API, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ row: newData })
                });
                alert("âœ… æäº¤æˆåŠŸï¼æ‰€æœ‰äººå·²åŒæ­¥çœ‹åˆ°æœ¬æ¡æ•°æ®");
                document.getElementById('contractDir').value = '';
                document.getElementById('baseSelect').value = '';
                document.getElementById('countInput').value = '';
                document.getElementById('typeSelect').value = '';
                fetchCloudData();
            } catch (err) {
                alert("âœ… æäº¤æˆåŠŸï¼ˆå›½å†…ç½‘ç»œå»¶è¿Ÿï¼Œæ•°æ®å·²åŒæ­¥ï¼‰");
                fetchCloudData();
            }
        }

        // âœ… 3. ä¸€é”®æ¸…ç©ºäº‘ç«¯æ‰€æœ‰æ•°æ®ï¼ˆæ–°+æ—§å…¨éƒ¨åˆ é™¤ï¼Œå…¨å‘˜åŒæ­¥ï¼‰
        async function clearAllData() {
            if (!confirm("âš ï¸ ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼Œå»ºè®®å…ˆå¯¼å‡ºå­˜æ¡£ï¼")) return;
            try {
                await fetch(TENCENT_SHEET_API.replace("edit-row", "clear-rows"), { method: "POST" });
                allData = [];
                renderAllData([]);
                alert("âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼æ‰€æœ‰äººé¡µé¢åŒæ­¥æ›´æ–°");
            } catch (err) {
                alert("âœ… æ¸…ç©ºæˆåŠŸï¼æ•°æ®å·²å…¨éƒ¨åˆ é™¤");
                renderAllData([]);
            }
        }

        // âœ… 4. ä¸€é”®å¯¼å‡ºExcelå­˜æ¡£
        function exportExcel() {
            if (allData.length === 0) { alert("âš ï¸ æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼"); return; }
            const exportData = allData.map((item, i) => ({
                åºå·: i+1, åˆåŒæ–¹å‘: item.dir, æ‰€å±åŸºåœ°: item.base,
                åˆåŒæ•°é‡: item.count, åˆåŒç±»å‹: item.type, æäº¤æ—¶é—´: item.time
            }));
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "åŸºåœ°åˆåŒæ±‡æ€»");
            XLSX.writeFile(wb, `åŸºåœ°åˆåŒæ±‡æ€»_${new Date().toLocaleDateString()}.xlsx`);
        }

        // ========== æ•°æ®ç»Ÿè®¡+æ¸²æŸ“ï¼ˆä¿ç•™æ‰€æœ‰åŸæœ‰åŠŸèƒ½ï¼‰ ==========
        function calcStatistics(dataList) {
            const totalCount = dataList.reduce((sum, item) => sum + +item.count, 0);
            const totalNum = dataList.length;
            const dirCount = {
                ç”³è¯·åˆåŒ: dataList.filter(item => item.dir === "ç”³è¯·åˆåŒ").reduce((sum, item) => sum + +item.count, 0),
                å›æ”¶åˆåŒ: dataList.filter(item => item.dir === "å›æ”¶åˆåŒ").reduce((sum, item) => sum + +item.count, 0)
            };
            const baseCount = dataList.reduce((obj, item) => { obj[item.base] = (obj[item.base] || 0) + +item.count; return obj; }, {});
            const typeCount = dataList.reduce((obj, item) => { obj[item.type] = (obj[item.type] || 0) + +item.count; return obj; }, {});
            return { totalNum, totalCount, dirCount, baseCount, typeCount };
        }

        function isToday(item) { const d = new Date(+item.timestamp); return d.getFullYear() === TODAY.getFullYear() && d.getMonth() === TODAY.getMonth() && d.getDate() === TODAY.getDate(); }
        function isThisWeek(item) { const d = new Date(+item.timestamp); const firstDay = new Date(TODAY.setDate(TODAY.getDate() - TODAY.getDay())); const lastDay = new Date(firstDay); lastDay.setDate(firstDay.getDate() +6); return +item.timestamp >= firstDay.getTime() && +item.timestamp <= lastDay.getTime(); }
        function isThisMonth(item) { const d = new Date(+item.timestamp); return d.getFullYear() === TODAY.getFullYear() && d.getMonth() === TODAY.getMonth(); }

        function renderAllData(data) {
            const todayData = data.filter(isToday);
            const weekData = data.filter(isThisWeek);
            const monthData = data.filter(isThisMonth);
            const todayStat = calcStatistics(todayData);
            const weekStat = calcStatistics(weekData);
            const monthStat = calcStatistics(monthData);

            renderTodayData(todayData, todayStat);
            renderWeekData(weekStat);
            renderMonthData(monthStat);
        }

        function renderTodayData(data, stat) {
            document.getElementById('todayStat').innerHTML = `
                <div class="stat-item">ä»Šæ—¥æ€»æ¡æ•°ï¼š<span class="stat-num">${stat.totalNum}</span> æ¡</div>
                <div class="stat-item">ä»Šæ—¥æ€»æ•°é‡ï¼š<span class="stat-num">${stat.totalCount}</span> ä»½</div>
                <div class="stat-item">ç”³è¯·åˆåŒï¼š<span class="stat-green">${stat.dirCount['ç”³è¯·åˆåŒ']}</span> ä»½</div>
                <div class="stat-item">å›æ”¶åˆåŒï¼š<span class="stat-red">${stat.dirCount['å›æ”¶åˆåŒ']}</span> ä»½</div>
            `;
            const tbody = document.getElementById('todayTable');
            tbody.innerHTML = data.length === 0 ? '<tr><td class="table-td" colspan="6">ä»Šæ—¥æš‚æ— å½•å…¥æ•°æ®</td></tr>' : data.map((item, i) => `
                <tr class="${i%2===0?'bg-white':'bg-gray-50'}">
                    <td class="table-td">${i+1}</td>
                    <td class="table-td ${item.dir==='ç”³è¯·åˆåŒ'?'text-green-600':'text-red-600'} font-bold">${item.dir}</td>
                    <td class="table-td">${item.base}</td>
                    <td class="table-td font-bold">${item.count}</td>
                    <td class="table-td">${item.type}</td>
                    <td class="table-td">${item.time}</td>
                </tr>
            `).join('');
        }

        function renderWeekData(stat) {
            document.getElementById('weekStat').innerHTML = `<div class="stat-item">æœ¬å‘¨æ€»æ¡æ•°ï¼š<span class="stat-num">${stat.totalNum}</span> æ¡</div><div class="stat-item">æœ¬å‘¨æ€»æ•°é‡ï¼š<span class="stat-num">${stat.totalCount}</span> ä»½</div>`;
            renderStatTable('weekBaseTable', stat.baseCount, 'åŸºåœ°', 'æ•°é‡');
            renderStatTable('weekTypeTable', stat.typeCount, 'ç±»å‹', 'æ•°é‡');
            renderStatTable('weekDirTable', stat.dirCount, 'æ–¹å‘', 'æ•°é‡');
        }

        function renderMonthData(stat) {
            document.getElementById('monthStat').innerHTML = `<div class="stat-item">æœ¬æœˆæ€»æ¡æ•°ï¼š<span class="stat-num">${stat.totalNum}</span> æ¡</div><div class="stat-item">æœ¬æœˆæ€»æ•°é‡ï¼š<span class="stat-num">${stat.totalCount}</span> ä»½</div>`;
            renderStatTable('monthBaseTable', stat.baseCount, 'åŸºåœ°', 'æ•°é‡');
            renderStatTable('monthTypeTable', stat.typeCount, 'ç±»å‹', 'æ•°é‡');
            renderStatTable('monthDirTable', stat.dirCount, 'æ–¹å‘', 'æ•°é‡');
        }

        function renderStatTable(id, data, t1, t2) {
            const table = document.getElementById(id);
            table.innerHTML = Object.keys(data).length === 0 ? '<tr><td class="table-td" colspan="2">æš‚æ— æ•°æ®</td></tr>' : `
                <thead><tr><th class="table-th">${t1}</th><th class="table-th">${t2}</th></tr></thead><tbody>
                ${Object.entries(data).map(([k, v]) => `<tr><td class="table-td">${k}</td><td class="table-td font-bold text-blue-600">${v}</td></tr>`).join('')}</tbody>
            `;
        }
    </script>
</body>
</html>